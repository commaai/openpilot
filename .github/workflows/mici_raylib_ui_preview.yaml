name: "mici raylib ui preview"
on:
  push:
    branches:
      - master
  pull_request:
    types: [assigned, opened, synchronize, reopened, edited]
    branches:
      - 'master'
    paths:
      - 'selfdrive/assets/**'
      - 'selfdrive/ui/**'
      - 'system/ui/**'
  workflow_dispatch:

env:
  UI_JOB_NAME: "Create mici raylib UI Report"
  REPORT_NAME: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' && 'master' || github.event.number }}
  SHA: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' && github.sha || github.event.pull_request.head.sha }}
  BRANCH_NAME: "openpilot/pr-${{ github.event.number }}-mici-raylib-ui"
  # All report files are pushed here
  REPORT_FILES_BRANCH_NAME: "mici-raylib-ui-reports"

jobs:
  preview:
    if: github.repository == 'commaai/openpilot'
    name: preview
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
#      - name: Waiting for ui generation to start
#        run: sleep 30

      - name: Waiting for ui generation to end
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ env.SHA }}
          check-name: ${{ env.UI_JOB_NAME }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          allowed-conclusions: success
          wait-interval: 20

      - name: Getting workflow run ID
        id: get_run_id
        run: |
          echo "run_id=$(curl https://api.github.com/repos/${{ github.repository }}/commits/${{ env.SHA }}/check-runs | jq -r '.check_runs[] | select(.name == "${{ env.UI_JOB_NAME }}") | .html_url | capture("(?<number>[0-9]+)") | .number')" >> $GITHUB_OUTPUT

      - name: Getting proposed ui
        id: download-artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          run_id: ${{ steps.get_run_id.outputs.run_id }}
          search_artifacts: true
          name: mici-raylib-report-1-${{ env.REPORT_NAME }}
          path: ${{ github.workspace }}/pr_ui

      - name: Getting master ui
        uses: actions/checkout@v4
        with:
          repository: commaai/ci-artifacts
          ssh-key: ${{ secrets.CI_ARTIFACTS_DEPLOY_KEY }}
          path: ${{ github.workspace }}/master_ui_raylib
          ref: openpilot_master_ui_mici_raylib

      - name: Saving new master ui
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        working-directory: ${{ github.workspace }}/master_ui_raylib
        run: |
          git checkout --orphan=new_master_ui_mici_raylib
          git rm -rf *
          git branch -D openpilot_master_ui_mici_raylib
          git branch -m openpilot_master_ui_mici_raylib
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
          mv ${{ github.workspace }}/pr_ui/* .
          git add .
          git commit -m "mici raylib video for commit ${{ env.SHA }}"
          git push origin openpilot_master_ui_mici_raylib --force

      - name: Setup FFmpeg
        uses: AnimMouse/setup-ffmpeg@v1

      - name: Finding diff
        # TODO: change back to pull_request_target
        if: github.event_name == 'pull_request'
        id: find_diff
        run: |
          # TODO: needed?
          # sudo apt-get update && sudo apt-get install -y ffmpeg

          # Find the video file from PR
          pr_video="${{ github.workspace }}/pr_ui/mici_ui_replay.mp4"
          master_video="${{ github.workspace }}/master_ui_raylib/mici_ui_replay.mp4"

          ls -lah ${{ github.workspace }}/pr_ui
          ls -lah ${{ github.workspace }}/master_ui_raylib

          if [ ! -f "$master_video" ]; then
            master_video="$pr_video"
          fi

          #            DIFF="<p>âœ… New video: <a href=\"https://raw.githubusercontent.com/commaai/ci-artifacts/${{ env.BRANCH_NAME }}/mici_ui_replay.mp4\">View Video</a></p>"
          #          else

          cp "$master_video" "${{ github.workspace }}/pr_ui/mici_ui_replay_master.mp4"
          cp "$pr_video" "${{ github.workspace }}/pr_ui/mici_ui_replay_proposed.mp4"

          export PYTHONPATH=${{ github.workspace }}
          baseurl="https://github.com/commaai/ci-artifacts/raw/refs/heads/${{ env.BRANCH_NAME }}"
          python3 ${{ github.workspace }}/selfdrive/ui/tests/diff/diff.py "${{ github.workspace }}/pr_ui/mici_ui_replay_master.mp4" "${{ github.workspace }}/pr_ui/mici_ui_replay_proposed.mp4" "diff.html" --basedir "$baseurl" --no-open || true

          # Copy videos with renamed filenames to prevent overwriting in future PRs


          # Copy diff report files
          ls -lah ${{ github.workspace }}/selfdrive/ui/tests/diff/report/
          # TODO: includes duplicate proposed file?
          # cp -r ${{ github.workspace }}/selfdrive/ui/tests/diff/report/* ${{ github.workspace }}/pr_ui/
          cp ${{ github.workspace }}/selfdrive/ui/tests/diff/report/diff.html ${{ github.workspace }}/pr_ui/
          cp ${{ github.workspace }}/selfdrive/ui/tests/diff/report/diff.mp4 ${{ github.workspace }}/pr_ui/
          # cp ${{ github.workspace }}/master_ui_raylib/mici_ui_replay.mp4 ${{ github.workspace }}/pr_ui/mici_ui_replay_master.mp4

          echo "DIFF=$DIFF" >> "$GITHUB_OUTPUT"

      - name: Saving proposed ui
        if: github.event_name == 'pull_request'
        working-directory: ${{ github.workspace }}/master_ui_raylib
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
          git checkout --orphan=${{ env.BRANCH_NAME }}
          git rm -rf *
          mv ${{ github.workspace }}/pr_ui/* .
          git add .
          git commit -m "mici raylib video for PR #${{ github.event.number }}"
          git push origin ${{ env.BRANCH_NAME }} --force

          # cp agian
          cp ${{ github.workspace }}/selfdrive/ui/tests/diff/report/diff.html ${{ github.workspace }}/pr_ui/

          # Push just diff.html, don't overwrite other reports
          git fetch origin ${{ env.REPORT_FILES_BRANCH_NAME }}
          git checkout ${{ env.REPORT_FILES_BRANCH_NAME }}
          cp ${{ github.workspace }}/pr_ui/diff.html diff_pr_${{ github.event.number }}.html
          git add diff_pr_${{ github.event.number }}.html
          git commit -m "mici raylib ui diff report for PR #${{ github.event.number }}"
          git push origin ${{ env.REPORT_FILES_BRANCH_NAME }}

      - name: Comment Video on PR
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            <!-- _(run_id_video_mici_raylib **${{ github.run_id }}**)_ -->
            ## mici raylib UI Preview
            ${{ steps.find_diff.outputs.DIFF }}
          comment_tag: run_id_video_mici_raylib
          pr_number: ${{ github.event.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
