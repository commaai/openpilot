Import('env', 'envCython', 'common', 'messaging', 'arch')

libs = ['usb-1.0', common, messaging, 'pthread']
panda = env.Library('panda', ['panda.cc', 'panda_comms.cc', 'spi.cc'])

link_flags = []
if arch == "Darwin":
  link_flags = ["-bundle", "-undefined", "dynamic_lookup"]
else:
  link_flags = ["-shared"]

libpandad = env.Program('libpandad.so', ['pandad_capi.cc'],
                        LIBS=[panda, 'can_list_to_can_capnp', 'capnp', 'kj'] + libs,
                        LINKFLAGS=link_flags)

env.Library('libcan_list_to_can_capnp', ['can_list_to_can_capnp.cc'])

Export('libpandad')

if GetOption('extras'):
  env.Program('tests/test_pandad_usbprotocol', ['tests/test_pandad_usbprotocol.cc'], LIBS=[panda] + libs)
